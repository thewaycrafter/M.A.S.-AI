'use client';

import { useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Area, AreaChart } from 'recharts';
import styles from './VulnerabilityTimeline.module.css';

interface ScanHistory {
    timestamp: Date;
    critical: number;
    high: number;
    medium: number;
    low: number;
    total: number;
}

interface VulnerabilityTimelineProps {
    scans: ScanHistory[];
}

export default function VulnerabilityTimeline({ scans }: VulnerabilityTimelineProps) {
    const chartData = useMemo(() => {
        return scans.map((scan) => ({
            date: new Date(scan.timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
            Critical: scan.critical,
            High: scan.high,
            Medium: scan.medium,
            Low: scan.low,
            Total: scan.total,
        }));
    }, [scans]);

    const CustomTooltip = ({ active, payload, label }: any) => {
        if (!active || !payload) return null;

        return (
            <div className={styles.tooltip}>
                <p className={styles.tooltipLabel}>{label}</p>
                {payload.map((entry: any, index: number) => (
                    <p key={index} className={styles.tooltipItem} style={{ color: entry.color }}>
                        <span className={styles.tooltipDot} style={{ background: entry.color }}></span>
                        {entry.name}: {entry.value}
                    </p>
                ))}
            </div>
        );
    };

    if (scans.length === 0) {
        return (
            <div className={styles.emptyState}>
                <p>ðŸ“Š No historical scan data available</p>
                <p className={styles.emptyHint}>Run multiple scans to see vulnerability trends over time</p>
            </div>
        );
    }

    return (
        <div className={styles.container}>
            <div className={styles.header}>
                <h2>Vulnerability Trends</h2>
                <p className={styles.subtitle}>Historical analysis of security vulnerabilities over time</p>
            </div>

            <div className={styles.chartContainer}>
                <ResponsiveContainer width="100%" height={400}>
                    <AreaChart data={chartData}>
                        <defs>
                            <linearGradient id="colorCritical" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ff0040" stopOpacity={0.8} />
                                <stop offset="95%" stopColor="#ff0040" stopOpacity={0} />
                            </linearGradient>
                            <linearGradient id="colorHigh" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ff6b00" stopOpacity={0.8} />
                                <stop offset="95%" stopColor="#ff6b00" stopOpacity={0} />
                            </linearGradient>
                            <linearGradient id="colorMedium" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ffaa00" stopOpacity={0.8} />
                                <stop offset="95%" stopColor="#ffaa00" stopOpacity={0} />
                            </linearGradient>
                            <linearGradient id="colorLow" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="#ffd700" stopOpacity={0.8} />
                                <stop offset="95%" stopColor="#ffd700" stopOpacity={0} />
                            </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" stroke="#00ff4120" />
                        <XAxis dataKey="date" stroke="#00ff41" style={{ fontSize: '12px', fontFamily: 'monospace' }} />
                        <YAxis stroke="#00ff41" style={{ fontSize: '12px', fontFamily: 'monospace' }} />
                        <Tooltip content={<CustomTooltip />} />
                        <Legend wrapperStyle={{ fontFamily: 'monospace', fontSize: '12px' }} />
                        <Area type="monotone" dataKey="Critical" stroke="#ff0040" fillOpacity={1} fill="url(#colorCritical)" />
                        <Area type="monotone" dataKey="High" stroke="#ff6b00" fillOpacity={1} fill="url(#colorHigh)" />
                        <Area type="monotone" dataKey="Medium" stroke="#ffaa00" fillOpacity={1} fill="url(#colorMedium)" />
                        <Area type="monotone" dataKey="Low" stroke="#ffd700" fillOpacity={1} fill="url(#colorLow)" />
                    </AreaChart>
                </ResponsiveContainer>
            </div>

            <div className={styles.stats}>
                <div className={styles.statCard}>
                    <h3>Latest Scan</h3>
                    <p className={styles.statValue}>{scans[scans.length - 1]?.total || 0}</p>
                    <p className={styles.statLabel}>Total Vulnerabilities</p>
                </div>
                <div className={styles.statCard}>
                    <h3>Average</h3>
                    <p className={styles.statValue}>
                        {Math.round(scans.reduce((sum, s) => sum + s.total, 0) / scans.length)}
                    </p>
                    <p className={styles.statLabel}>Per Scan</p>
                </div>
                <div className={styles.statCard}>
                    <h3>Trend</h3>
                    <p className={styles.statValue} style={{ color: scans[scans.length - 1]?.total > scans[0]?.total ? '#ff0040' : '#00ff41' }}>
                        {scans[scans.length - 1]?.total > scans[0]?.total ? 'â†‘' : 'â†“'}
                        {Math.abs(Math.round(((scans[scans.length - 1]?.total - scans[0]?.total) / scans[0]?.total) * 100))}%
                    </p>
                    <p className={styles.statLabel}>Since First Scan</p>
                </div>
            </div>
        </div>
    );
}
